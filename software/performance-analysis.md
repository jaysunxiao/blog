#服务器无响应线上问题分析
1. 发现问题，有用户无法连接服务器

2. 因为是集群，先定位哪个服务器出了问题
    1. zookeeper #通过zookeeper查看服务器集群，看看业务逻辑服临时节点是否还在，在的说明还有心跳
    2. redis，不需要查看redis集群，因为业务是先查看缓存，缓存没有再查库，即使出问题也不影响正常的业务
    3. 数据库集群，通过自己写的工具查看数据服务器，一般数据服务器磁盘有没有满，有心跳（一分钟），就没有多大问题
    4. 排除了redis缓存集群和数据库集群后，剩下的就是业务集群和登录集群
    
3. 业务集群排查，最可能出问题的是业务集群，因为代码量最大，最容易出错，登录服逻辑相对简单
    1. uptime       #查看CPU的Load情况，Load越高说明问题越严重
    2. free -m      #查看内存
    3. df           #查看磁盘空间
    4. netstat      #查看网络状态
    5. ping         #能否连接其它服务器
    
4. 然后再排查是不是jvm的问题
    1. jps      #查看相关的java进程是否还在运行
    2. jstack   #定位死循环、线程阻塞、死锁，因为业务逻辑是最复杂最容易出错的，所以先定位上业务是否有问题
    3. jmap     #查看是否有内存泄漏，查看大对象，如果Java的集合类使用不当，可能导致很多类没有被释放，依然有引用，这也是最容易出错的地方之一；
                #也可使用Eclipse的MAT（Memory Analyzer Tool）来分析dump文件，这样可以更加清晰一点，查找java.lang.ref.Finalizer
    4. jstat    #查看FGC发生的频率及FGC所花费的时间，FGC发生的频率越快、花费的时间越高，问题越严重，会stop world
    5. 


#服务器线上环境配置

##一、服务器部署
- 全球集中式部署在美国的机房
```
优点：
1. 服务器集中，⽅便部署
2. 服务器之间是内⽹，安全，⾼效。
3. 数据集中，不存在数据不⼀致的问题。
缺点：
1. 部分玩家延迟会很⾼，影响游戏体验。
```

- 服务器分配，服务器性能
```
gate 3
login 6
home 50
world 10
battle 10
redis 3
db 10 + 10

注册/登录的量在400/s
其它的qps在1w
```

- 网络代理
```
AWS全球平均延迟300ms
网宿和阿卡迈代理方案
```

- 服务器容灾
```
保证服务器正常运⾏：逻辑容灾。
防⽌玩家数据丢失：数据容灾。
```

- 项目的参数配置
```
-Xms4g                          # 最小的堆大小
-XX:+UseG1GC                    # jdk8过后就不用设置，是默认值
-XX:MaxGCPauseMillis=250        # 默认200
-XX:MaxTenuringThreshold=2      # 对象晋升老年代的年龄阈值
-XX:ParallelGCThreads=20        # STW期间，并行GC线程数
```



##二、网关服
- 三个网关服务器，可以横向扩展，理论上可以支持无限的流量
```
gate 1000M bit 上传和下载可以达到100MB/s
gate的网卡是100Mb/s
gate的是8核24G内存
```

##数据中心日志服务器
- 巅峰时，每天可以产生10GB的数据



#开源项目
- 使用过NetBeans编译过OpenJdk源码
```
首先安装一个带界面的Linux系统，在自己的windows电脑上装10次以上才算真正会装Linux，现在带界面的系统非常简单，直接选择Desktop选项就可以了。

安装完成后，在命令行输入startx就可以启动界面系统。

然后再按照官方指南装一个NetBeans Idea，下载openjdk，然后用NetBeans直接打开OpenJdk，Build这个项目就可以了，大概需要半个小时，看你电脑的配置。

因为OpenJdk是C++，还要确保有C++的编译环境。

OpenJdk中有一个Demo是Java写的，你可以直接运行，然后你可以在NetBeans里断点，从底层调试Java。

全局搜索GCRoot，找到GCRoot的数据结构，还有使用的地方，断点，你就可以知道GCRoot到底是什么了。

```
